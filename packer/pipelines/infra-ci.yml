trigger:
  branches:
    include:
      - main
      - gh-readonly-queue/*
    exclude:
      - app
      - infrastructure
  paths:
    include:
      - packer
    exclude:
      - app
      - infrastructure

resources:
  pipelines:
    - pipeline: terraform-ci
      source: Infrastructure PR

  repositories:
    - repository: templates
      type: github
      endpoint: Planning-Inspectorate
      name: Planning-Inspectorate/common-pipeline-templates
      ref: refs/heads/main

extends:
  template: stages/wrapper_ci.yml@templates
  parameters:
    pool:
      name: pins-template-test
    # validateName: Validate Terraform
    validationSteps:
      - script: |
          echo "=== Agent Environment Information ==="
          echo "Current working directory: $(pwd)"
          echo "###########################################################"
          echo "Checking NVM installation..."

          if [ -d "/usr/local/nvm" ]; then
            echo "✅ NVM directory exists at: /usr/local/nvm"
            echo "NVM directory contents:"
            ls -la /usr/local/nvm/
            echo "###########################################################"
            echo "Available Node.js versions:"
            ls -la /usr/local/nvm/versions/node/ 2>/dev/null || echo "❌ No Node versions directory found"
          else
            echo "❌ NVM directory not found at /usr/local/nvm"
          fi

          echo "###########################################################"
          echo "Current PATH: $PATH"
          echo "=== Environment Check Completed ==="
        displayName: 'Check Agent Environment & NVM Location'

      - script: |
          echo "=== Testing Direct Node.js Access (No Setup Required) ==="
          echo "Current PATH: $PATH"
          echo "###########################################################"
          echo "Testing Node.js availability..."
          node -v || echo "❌ Node.js not found"
          npm -v || echo "❌ NPM not found"
          echo "###########################################################"
          echo "Testing executable locations..."
          which node || echo "❌ Node.js executable not found"
          which npm || echo "❌ NPM executable not found"
          echo "###########################################################"
          echo "Testing NPM functionality..."
          npm --version || echo "❌ NPM command failed"
          npm config get registry || echo "❌ NPM config failed"
          echo "###########################################################"
          echo "� Goal: Node.js should work directly without any pipeline setup!"
          echo "=== Direct Access Test Completed ==="
        displayName: 'Test Direct Node.js Access (Symlinks)'

      # - template: steps/terraform_format.yml@templates
      # - template: steps/terraform_tflint.yml@templates
      # - template: steps/run_checkov.yml@templates
      # - template: steps/terraform_validate.yml@templates
      #   parameters:
      #     workingDirectory: $(Build.Repository.LocalPath)/packer/infra
